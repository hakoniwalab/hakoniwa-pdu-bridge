<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Hakoniwa Bridge Visualizer v2.3 - Directional Edition</title>

  <link rel="stylesheet" href="https://unpkg.com/reactflow@11.11.4/dist/style.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; overflow: hidden; background: #f1f5f9; }
    .app { width: 100%; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #1e293b; color: white; padding: 0.75rem 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1); z-index: 50; display: flex; justify-content: space-between; align-items: center; }
    .main { flex: 1; display: flex; overflow: hidden; }
    
    /* Sidebar */
    .sidebar { width: 480px; border-right: 1px solid #e2e8f0; background: #fff; padding: 1.25rem; overflow-y: auto; z-index: 40; display: flex; flex-direction: column; }
    .canvas { flex: 1; position: relative; background: #f8fafc; }

    .btn { cursor: pointer; border: none; padding: .6rem .8rem; border-radius: .4rem; font-weight: 600; font-size: 13px; }
    .btn.primary { background: #2563eb; color: #fff; }
    .btn.outline { background: transparent; border: 1px solid #cbd5e1; color: #334155; }

    textarea {
      width: 100%; flex: 1; font-family: 'SFMono-Regular', Consolas, monospace;
      font-size: 11px; padding: .75rem; border: 1px solid #e2e8f0; border-radius: .35rem; resize: none; margin-bottom: 1rem;
      background: #fdfdfd; line-height: 1.4;
    }

    .error-box { margin-bottom: 1rem; padding: .75rem; background: #fef2f2; border: 1px solid #fca5a5; border-radius: .35rem; color: #b91c1c; font-size: 12px; }

    /* --- Custom Node Styles --- */
    .bridge-node { background: #fff; border: 2px solid #334155; border-radius: 10px; min-width: 320px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .node-header { background: #334155; color: white; padding: 10px 14px; border-radius: 8px 8px 0 0; font-weight: 800; font-size: 14px; text-align: center; }
    .node-body { padding: 14px; }
    
    .section-title { font-size: 10px; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin: 15px 0 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; }

    /* Endpoints */
    .ep-item { position: relative; display: flex; align-items: center; margin-bottom: 8px; height: 32px; }
    .pill {
      display: flex; align-items: center; width: 100%; padding: 6px 12px; border-radius: 6px;
      font-size: 11px; font-weight: 700; border: 1px solid; justify-content: space-between;
    }
    .pill.local { background: #f8fafc; border-color: #cbd5e1; color: #475569; border-style: dashed; }
    .pill.wire  { background: #faf5ff; border-color: #e9d5ff; color: #7e22ce; }
    .direction-icon { font-size: 14px; opacity: 0.8; }

    /* ReactFlow Handles */
    .react-flow__handle { width: 12px; height: 12px; border: 2px solid #fff; }
    .handle-in { background: #3b82f6 !important; } /* Blue for input */
    .handle-out { background: #a855f7 !important; } /* Purple for output */

    /* Connections */
    .conn-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; margin-top: 8px; }
    .conn-path { font-family: monospace; font-size: 11px; font-weight: bold; color: #1e293b; margin-bottom: 6px; display: block; border-left: 3px solid #3b82f6; padding-left: 6px; }
    .pdu-group-box { margin-top: 6px; padding-left: 4px; }
    .pdu-row { font-size: 10px; color: #64748b; margin-bottom: 2px; display: block; }
    .policy-tag { font-size: 9px; background: #fee2e2; color: #b91c1c; padding: 1px 4px; border-radius: 4px; margin-left: 6px; font-weight: normal; }

    input[type="file"] { display: none; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/reactflow@11.11.4/dist/umd/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv7.min.js"></script>

  <script>
    window.addEventListener("load", () => {
      const { useState, useEffect, useCallback } = React;
      const { ReactFlow, Background, Controls, MiniMap, Panel, useNodesState, useEdgesState, MarkerType, Handle, Position } = window.ReactFlow;

      const SAMPLE_DATA = {
        "version": "2.0.0",
        "transferPolicies": {
          "immediate": { "type": "immediate" },
          "throttle1": { "type": "throttle", "intervalMs": 10 },
          "ticker1": { "type": "ticker", "intervalMs": 100 }
        },
        "nodes": [{ "id": "node1" }, { "id": "node2" }, { "id": "node3" }],
        "endpoints": [
          {
            "nodeId": "node1",
            "endpoints": [
              { "id": "n1-epSrc", "mode": "local", "direction": "in" },
              { "id": "n1-epDst-1", "mode": "wire", "direction": "out" },
              { "id": "n1-epDst-2", "mode": "wire", "direction": "out" }
            ]
          },
          {
            "nodeId": "node2",
            "endpoints": [
              { "id": "n2-epSrc", "mode": "wire", "direction": "in" },
              { "id": "n2-epDst", "mode": "local", "direction": "out" }
            ]
          },
          {
            "nodeId": "node3",
            "endpoints": [
              { "id": "n3-epSrc", "mode": "wire", "direction": "in" },
              { "id": "n3-epDst", "mode": "local", "direction": "out" }
            ]
          }
        ],
        "wireLinks": [
          { "from": "n1-epDst-1", "to": "n2-epSrc" },
          { "from": "n1-epDst-2", "to": "n3-epSrc" }
        ],
        "pduKeyGroups": {
          "pdu_group1": [
            { "id": "Robot1.camera", "robot_name": "Robot1", "pdu_name": "camera" },
            { "id": "Robot1.lidar",  "robot_name": "Robot1", "pdu_name": "lidar" }
          ],
          "pdu_group2": [
            { "id": "Robot2.camera", "robot_name": "Robot2", "pdu_name": "camera" }
          ]
        },
        "connections": [
          {
            "id": "conn1", "nodeId": "node1", "source": { "endpointId": "n1-epSrc" },
            "destinations": [{ "endpointId": "n1-epDst-1" }, { "endpointId": "n1-epDst-2" }],
            "transferPdus": [
              { "pduKeyGroupId": "pdu_group1", "policyId": "immediate" },
              { "pduKeyGroupId": "pdu_group2", "policyId": "throttle1" }
            ]
          },
          {
            "id": "conn2", "nodeId": "node2", "source": { "endpointId": "n2-epSrc" },
            "destinations": [{ "endpointId": "n2-epDst" }],
            "transferPdus": [{ "pduKeyGroupId": "pdu_group1", "policyId": "immediate" }]
          }
        ]
      };

      // ---- Custom Node ----
      function BridgeNode({ data }) {
        return React.createElement("div", { className: "bridge-node" },
          React.createElement("div", { className: "node-header" }, data.label),
          React.createElement("div", { className: "node-body" },
            
            React.createElement("div", { className: "section-title" }, "Endpoints"),
            (data.endpoints || []).map(ep => {
              const isWire = ep.mode === "wire";
              const isIn = ep.direction === "in";
              return React.createElement("div", { key: ep.id, className: "ep-item" },
                // IN „Åã„Å§ WIRE „Å™„ÇâÂ∑¶„Å´„Éè„É≥„Éâ„É´
                isWire && isIn && React.createElement(Handle, { 
                  type: "target", position: Position.Left, id: ep.id, className: "handle-in" 
                }),
                
                React.createElement("div", { className: "pill " + (isWire ? "wire" : "local") },
                  React.createElement("span", { className: "direction-icon" }, isIn ? "‚Üí" : " "),
                  React.createElement("span", { style: {flex: 1, padding: '0 8px'} }, ep.id),
                  React.createElement("span", { className: "direction-icon" }, !isIn ? "‚Üí" : " ")
                ),

                // OUT „Åã„Å§ WIRE „Å™„ÇâÂè≥„Å´„Éè„É≥„Éâ„É´
                isWire && !isIn && React.createElement(Handle, { 
                  type: "source", position: Position.Right, id: ep.id, className: "handle-out" 
                })
              );
            }),

            data.connections && data.connections.length > 0 && React.createElement(React.Fragment, null,
              React.createElement("div", { className: "section-title" }, "Connections"),
              data.connections.map((c, i) => 
                React.createElement("div", { key: i, className: "conn-card" },
                  React.createElement("span", { className: "conn-path" }, c.source + " ‚ûî " + c.destinations.join(", ")),
                  React.createElement("div", { className: "pdu-group-box" },
                    (c.transferPdus || []).map((tp, j) => 
                      React.createElement("div", { key: j, className: "pdu-row" }, 
                        "‚Ä¢ " + tp.pduKeyGroupId,
                        React.createElement("span", { className: "policy-tag" }, tp.policyId)
                      )
                    )
                  )
                )
              )
            )
          )
        );
      }

      const nodeTypes = { bridgeNode: BridgeNode };

      function App() {
        const [jsonText, setJsonText] = useState(JSON.stringify(SAMPLE_DATA, null, 2));
        const [nodes, setNodes, onNodesChange] = useNodesState([]);
        const [edges, setEdges, onEdgesChange] = useEdgesState([]);
        const [error, setError] = useState(null);

        const buildGraph = (config) => {
          const endpointToNode = new Map();
          const endpointsByNode = new Map();

          (config.endpoints || []).forEach(ne => {
            endpointsByNode.set(ne.nodeId, ne.endpoints || []);
            (ne.endpoints || []).forEach(ep => endpointToNode.set(ep.id, ne.nodeId));
          });

          const connsByNode = new Map();
          (config.connections || []).forEach(c => {
            if (!connsByNode.has(c.nodeId)) connsByNode.set(c.nodeId, []);
            connsByNode.get(c.nodeId).push({
              source: c.source.endpointId,
              destinations: (c.destinations || []).map(d => d.endpointId),
              transferPdus: c.transferPdus || []
            });
          });

          const newNodes = (config.nodes || []).map((n, idx) => ({
            id: n.id,
            type: "bridgeNode",
            position: { x: 50, y: 50 + idx * 300 }, // Á∏¶‰∏¶„Å≥Ê∞óÂë≥„Å´ÂàùÊúüÈÖçÁΩÆ
            data: {
              label: n.id,
              endpoints: endpointsByNode.get(n.id) || [],
              connections: connsByNode.get(n.id) || []
            }
          }));

          const newEdges = (config.wireLinks || []).map(link => ({
            id: `edge-${link.from}-${link.to}`,
            source: endpointToNode.get(link.from),
            target: endpointToNode.get(link.to),
            sourceHandle: link.from,
            targetHandle: link.to,
            animated: true,
            style: { stroke: "#a855f7", strokeWidth: 3 },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#a855f7" },
          })).filter(e => e.source && e.target);

          setNodes(newNodes);
          setEdges(newEdges);
        };

        const applyJson = useCallback((text) => {
          setError(null);
          try {
            const parsed = JSON.parse(text);
            buildGraph(parsed);
            setJsonText(text);
          } catch (e) {
            setError("JSON Error: " + e.message);
          }
        }, [setNodes, setEdges]);

        useEffect(() => applyJson(jsonText), []);

        const onFileChange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => applyJson(ev.target.result);
          reader.readAsText(file);
          e.target.value = "";
        };

        return React.createElement("div", { className: "app" },
          React.createElement("div", { className: "header" },
            React.createElement("div", { style: { fontWeight: 900 } }, "HAKONIWA BRIDGE VISUALIZER v2.3"),
            React.createElement("div", { style: {fontSize: '11px', opacity: 0.7} }, "Directional Handles (Left=In, Right=Out)")
          ),

          React.createElement("div", { className: "main" },
            React.createElement("div", { className: "sidebar" },
              React.createElement("div", { style: { display: 'flex', gap: '8px', marginBottom: '12px' } },
                React.createElement("button", { className: "btn primary", style: {flex:1}, onClick: () => applyJson(jsonText) }, "Apply Changes"),
                React.createElement("label", { className: "btn outline" }, "üìÇ Open File", 
                  React.createElement("input", { type: "file", onChange: onFileChange })
                )
              ),
              error && React.createElement("div", { className: "error-box" }, error),
              React.createElement("textarea", { value: jsonText, onChange: (e) => setJsonText(e.target.value), spellCheck: false }),
              React.createElement("div", { style: {fontSize: '11px', color: '#64748b', lineHeight: 1.5} },
                "‚óè direction: 'in' ‚ûî Â∑¶Á´ØÂ≠ê(Blue)\n" +
                "‚óè direction: 'out' ‚ûî Âè≥Á´ØÂ≠ê(Purple)\n" +
                "‚óè mode: 'local' ‚ûî Á´ØÂ≠ê„Å™„Åó(ÁÆ±Â∫≠ÂÜÖÈÉ®Áî®)"
              )
            ),

            React.createElement("div", { className: "canvas" },
              React.createElement(ReactFlow, {
                nodes, edges, onNodesChange, onEdgesChange, nodeTypes, fitView: true
              },
                React.createElement(Background, { gap: 24, color: "#e2e8f0" }),
                React.createElement(Controls),
                React.createElement(MiniMap)
              )
            )
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    });
  </script>
</body>
</html>