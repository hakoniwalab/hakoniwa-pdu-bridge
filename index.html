<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Hakoniwa PDU Bridge Visualizer</title>

  <!-- ReactFlow CSS (UMDÂêë„Åë„ÅØ style.css „ÅåÁ¥†Áõ¥) -->
  <link rel="stylesheet" href="https://unpkg.com/reactflow@11.11.4/dist/style.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; overflow: hidden; }
    .app { width: 100%; height: 100vh; display: flex; flex-direction: column; background: #f8fafc; }
    .header { background: #1e293b; color: white; padding: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
    .main { flex: 1; display: flex; overflow: hidden; }
    .sidebar { width: 36%; min-width: 360px; border-right: 1px solid #e2e8f0; background: #fff; padding: 1rem; overflow: auto; }
    .canvas { flex: 1; }
    .row { display: flex; gap: .5rem; align-items: center; }
    .row + .row { margin-top: .5rem; }

    .btn { cursor: pointer; border: none; padding: .5rem .75rem; border-radius: .4rem; font-weight: 600; }
    .btn.primary { background: #2563eb; color: #fff; }
    .btn.gray { background: #e2e8f0; color: #334155; }
    .btn.green { background: #16a34a; color: #fff; }
    .btn.amber { background: #d97706; color: #fff; }
    .btn.dark { background: #334155; color: #fff; }
    .btn:hover { opacity: .92; }

    textarea {
      width: 100%;
      height: 52vh;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      padding: .75rem;
      border: 1px solid #e2e8f0;
      border-radius: .35rem;
      resize: vertical;
    }

    .hint { color: #64748b; font-size: 12px; margin-top: .5rem; line-height: 1.4; }
    .error { margin-top: .75rem; padding: .75rem; background: #fef2f2; border: 1px solid #fca5a5; border-radius: .35rem; color: #b91c1c; font-size: 14px; }
    .ok { margin-top: .75rem; padding: .75rem; background: #ecfdf5; border: 1px solid #86efac; border-radius: .35rem; color: #166534; font-size: 14px; }

    .bridge-node {
      background: #fff;
      border: 2px solid #334155;
      border-radius: .6rem;
      padding: .9rem;
      min-width: 220px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.10);
    }
    .node-title { font-weight: 800; color: #0f172a; margin-bottom: .6rem; }
    .pill {
      display: inline-flex; align-items: center; gap: .4rem;
      padding: .25rem .45rem; border-radius: 999px;
      font-size: 12px; font-weight: 700;
      border: 1px solid;
    }
    .pill.local { background: #eff6ff; border-color: #93c5fd; color: #1d4ed8; }
    .pill.wire  { background: #faf5ff; border-color: #d8b4fe; color: #7e22ce; }

    .mini { font-size: 12px; color: #475569; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    input[type="file"] { display: none; }
    .small { font-size: 12px; color: #94a3b8; }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- ReactFlow UMD: globalThis.ReactFlow „Å´Áîü„Åà„Çã -->
  <script src="https://unpkg.com/reactflow@11.11.4/dist/umd/index.js"></script>

  <!-- Ajv UMD (draft-07): window.ajv7.default -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv7.min.js"></script>

  <script>
    window.addEventListener("load", () => {
      const { useState, useEffect, useMemo, useCallback } = React;

      // ---- ReactFlow global check ----
      if (!window.ReactFlow) {
        document.body.innerHTML = "<pre style='padding:16px'>ReactFlow UMD not loaded. Check CDN.</pre>";
        return;
      }
      const {
        ReactFlow,
        Background,
        Controls,
        MiniMap,
        Panel,
        useNodesState,
        useEdgesState,
        MarkerType
      } = window.ReactFlow;

      // ---- Ajv load (robust) ----
      function getAjvCtor() {
        // cdnjs ajv7.min.js -> window.ajv7.default
        if (window.ajv7 && (window.ajv7.default || window.ajv7)) return window.ajv7.default || window.ajv7;
        // fallback (rare)
        if (window.Ajv) return window.Ajv;
        return null;
      }

      // ---- Minimal Bridge schema („Åæ„Åö„ÅØ„ÄåÂ£ä„Çå„Å¶„Å™„ÅÑ„Äç„ÉÅ„Çß„ÉÉ„ÇØÁî®„ÅÆËäØ„Å†„Åë) ----
      // „Åì„Åì„ÅØ„ÅÇ„Å™„Åü„ÅÆ bridge-schema.json „Å´Âêà„Çè„Åõ„Å¶Âæå„ÅßËÜ®„Çâ„Åæ„Åõ„ÇãÊÉ≥ÂÆö„ÄÇ
      const BRIDGE_SCHEMA = {
        $schema: "http://json-schema.org/draft-07/schema#",
        type: "object",
        required: ["version", "transferPolicies", "nodes", "endpoints", "pduKeyGroups", "connections"],
        additionalProperties: true,
        properties: {
          version: { const: "2.0.0" },
          transferPolicies: { type: "object" },
          nodes: {
            type: "array",
            items: { type: "object", required: ["id"], properties: { id: { type: "string", minLength: 1 } } }
          },
          endpoints: {
            type: "array",
            items: {
              type: "object",
              required: ["nodeId", "endpoints"],
              properties: {
                nodeId: { type: "string", minLength: 1 },
                endpoints: {
                  type: "array",
                  items: {
                    type: "object",
                    required: ["id", "mode"],
                    properties: {
                      id: { type: "string", minLength: 1 },
                      mode: { enum: ["local", "wire"] }
                    }
                  }
                }
              }
            }
          },
          wireLinks: {
            type: "array",
            items: { type: "object", required: ["from", "to"], properties: { from: { type: "string" }, to: { type: "string" } } }
          },
          pduKeyGroups: { type: "object" },
          connections: {
            type: "array",
            items: {
              type: "object",
              required: ["id", "nodeId", "source", "destinations", "transferPdus"],
              properties: {
                id: { type: "string" },
                nodeId: { type: "string" },
                source: { type: "object", required: ["endpointId"], properties: { endpointId: { type: "string" } } },
                destinations: { type: "array", minItems: 1, items: { type: "object", required: ["endpointId"], properties: { endpointId: { type: "string" } } } },
                transferPdus: { type: "array", minItems: 1, items: { type: "object", required: ["pduKeyGroupId", "policyId"], properties: { pduKeyGroupId: { type: "string" }, policyId: { type: "string" } } } }
              }
            }
          }
        }
      };

      const SAMPLE_CONFIG = {
        "version": "2.0.0",
        "transferPolicies": {
          "immediate_policy": { "type": "immediate" },
          "limit_100ms": { "type": "throttle", "intervalMs": 100 }
        },
        "nodes": [{ "id": "node1" }, { "id": "node2" }],
        "endpoints": [
          {
            "nodeId": "node1",
            "endpoints": [
              { "id": "n1-src", "mode": "local" },
              { "id": "n1-dst", "mode": "wire" }
            ]
          },
          {
            "nodeId": "node2",
            "endpoints": [
              { "id": "n2-src", "mode": "wire" },
              { "id": "n2-dst", "mode": "local" }
            ]
          }
        ],
        "wireLinks": [{ "from": "n1-dst", "to": "n2-src" }],
        "pduKeyGroups": {
          "drone_data": [
            { "id": "Drone.pos", "robot_name": "Drone", "pdu_name": "pos" },
            { "id": "Drone.status", "robot_name": "Drone", "pdu_name": "status" }
          ]
        },
        "connections": [
          {
            "id": "node1_to_node2_conn",
            "nodeId": "node1",
            "source": { "endpointId": "n1-src" },
            "destinations": [{ "endpointId": "n1-dst" }],
            "transferPdus": [{ "pduKeyGroupId": "drone_data", "policyId": "immediate_policy" }]
          },
          {
            "id": "node2_from_node1_conn",
            "nodeId": "node2",
            "source": { "endpointId": "n2-src" },
            "destinations": [{ "endpointId": "n2-dst" }],
            "transferPdus": [{ "pduKeyGroupId": "drone_data", "policyId": "limit_100ms" }]
          }
        ]
      };

      // ---- Node renderer ----
      function BridgeNode({ data }) {
        return React.createElement("div", { className: "bridge-node" },
          React.createElement("div", { className: "node-title" }, data.label),

          React.createElement("div", { className: "mini", style: { marginBottom: ".5rem" } }, "endpoints"),
          React.createElement("div", { style: { display: "flex", flexWrap: "wrap", gap: ".35rem" } },
            (data.endpoints || []).map(ep =>
              React.createElement("span", { key: ep.id, className: "pill " + (ep.mode === "wire" ? "wire" : "local") },
                React.createElement("span", { className: "mono" }, ep.id),
                React.createElement("span", null, ep.mode)
              )
            )
          ),

          data.connections && data.connections.length > 0
            ? React.createElement("div", { style: { marginTop: ".75rem", borderTop: "1px solid #e2e8f0", paddingTop: ".6rem" } },
                React.createElement("div", { className: "mini", style: { marginBottom: ".35rem" } }, "connections"),
                data.connections.map((c, i) =>
                  React.createElement("div", { key: i, style: { background: "#f8fafc", border: "1px solid #e2e8f0", borderRadius: ".35rem", padding: ".5rem", marginTop: ".35rem" } },
                    React.createElement("div", { className: "mono", style: { fontSize: "12px" } }, c.source + " ‚Üí " + c.destinations.join(", ")),
                    React.createElement("div", { style: { marginTop: ".35rem", display: "flex", flexDirection: "column", gap: ".15rem" } },
                      c.transferPdus.map((tp, j) =>
                        React.createElement("div", { key: j, className: "small mono" }, "üì¶ " + tp.pduKeyGroupId + " @ " + tp.policyId)
                      )
                    )
                  )
                )
              )
            : null
        );
      }

      const nodeTypes = { bridgeNode: BridgeNode };

      function buildGraph(config) {
        const endpointsByNode = new Map();
        (config.endpoints || []).forEach(ne => {
          endpointsByNode.set(ne.nodeId, ne.endpoints || []);
        });

        const connectionsByNode = new Map();
        (config.connections || []).forEach(conn => {
          if (!connectionsByNode.has(conn.nodeId)) connectionsByNode.set(conn.nodeId, []);
          connectionsByNode.get(conn.nodeId).push({
            source: conn.source.endpointId,
            destinations: (conn.destinations || []).map(d => d.endpointId),
            transferPdus: conn.transferPdus || []
          });
        });

        const nodes = (config.nodes || []).map((n, idx) => ({
          id: n.id,
          type: "bridgeNode",
          position: { x: 120 + idx * 360, y: 120 },
          data: {
            label: n.id,
            endpoints: endpointsByNode.get(n.id) || [],
            connections: connectionsByNode.get(n.id) || []
          }
        }));

        // endpointId -> nodeId Ëß£Ê±∫
        const endpointToNode = new Map();
        (config.endpoints || []).forEach(ne => {
          (ne.endpoints || []).forEach(ep => endpointToNode.set(ep.id, ne.nodeId));
        });

        const edges = (config.wireLinks || []).map(link => {
          const sourceNode = endpointToNode.get(link.from);
          const targetNode = endpointToNode.get(link.to);
          return {
            id: link.from + "->" + link.to,
            source: sourceNode,
            target: targetNode,
            label: link.from + " ‚Üí " + link.to,
            animated: true,
            markerEnd: { type: MarkerType.ArrowClosed },
          };
        }).filter(e => e.source && e.target);

        return { nodes, edges };
      }

      function formatAjvErrors(errors) {
        if (!errors || !errors.length) return "";
        return errors.map(e => {
          const at = e.instancePath ? e.instancePath : "(root)";
          return `- ${at} ${e.message || ""}`.trim();
        }).join("\n");
      }

      function App() {
        const [jsonInput, setJsonInput] = useState(JSON.stringify(SAMPLE_CONFIG, null, 2));
        const [config, setConfig] = useState(SAMPLE_CONFIG);
        const [error, setError] = useState(null);
        const [okMsg, setOkMsg] = useState("Loaded sample.");
        const [schemaEnabled, setSchemaEnabled] = useState(true);

        const [nodes, setNodes, onNodesChange] = useNodesState([]);
        const [edges, setEdges, onEdgesChange] = useEdgesState([]);

        useEffect(() => {
          try {
            const g = buildGraph(config);
            setNodes(g.nodes);
            setEdges(g.edges);
          } catch (e) {
            // graph build errors are non-fatal
          }
        }, [config, setNodes, setEdges]);

        const validateWithAjv = useCallback((obj) => {
          if (!schemaEnabled) return { valid: true, message: "Schema validation is OFF." };

          const AjvCtor = getAjvCtor();
          if (!AjvCtor) return { valid: true, message: "Ajv not found. Validation skipped." };

          const ajv = new AjvCtor({ allErrors: true, strict: false });
          const validate = ajv.compile(BRIDGE_SCHEMA);
          const valid = validate(obj);
          if (!valid) {
            return { valid: false, message: "Schema validation failed:\n" + formatAjvErrors(validate.errors) };
          }
          return { valid: true, message: "Schema OK." };
        }, [schemaEnabled]);

        const loadFromText = useCallback((text) => {
          setError(null);
          setOkMsg(null);

          let parsed;
          try {
            parsed = JSON.parse(text);
          } catch (e) {
            setError("JSON Parse Error: " + e.message);
            return;
          }

          const v = validateWithAjv(parsed);
          if (!v.valid) {
            setError(v.message);
            // „Åì„Åì„ÅßÊ≠¢„ÇÅ„Çã„ÅÆ„ÅåÂ´å„Å™„Çâ„ÄÅsetConfig(parsed) „Åó„Å¶ ‚ÄúË≠¶ÂëäË°®Á§∫‚Äù „Å´„Åô„Çã„ÅÆ„ÇÇ„Ç¢„É™
            return;
          }

          setConfig(parsed);
          setOkMsg(v.message);
        }, [validateWithAjv]);

        const onClickLoad = useCallback(() => loadFromText(jsonInput), [jsonInput, loadFromText]);

        const onClickSample = useCallback(() => {
          const text = JSON.stringify(SAMPLE_CONFIG, null, 2);
          setJsonInput(text);
          loadFromText(text);
        }, [loadFromText]);

        const onFile = useCallback((e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            const text = String(reader.result || "");
            setJsonInput(text);
            loadFromText(text);
          };
          reader.readAsText(file);
        }, [loadFromText]);

        const onExport = useCallback(() => {
          const blob = new Blob([JSON.stringify(config, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "bridge.json";
          a.click();
          URL.revokeObjectURL(url);
        }, [config]);

        const stats = useMemo(() => {
          const n = (config.nodes || []).length;
          const wl = (config.wireLinks || []).length;
          const p = config.transferPolicies ? Object.keys(config.transferPolicies).length : 0;
          const c = (config.connections || []).length;
          return { n, wl, p, c };
        }, [config]);

        return React.createElement("div", { className: "app" },
          React.createElement("div", { className: "header" },
            React.createElement("div", { style: { fontSize: "20px", fontWeight: 900 } }, "üîß Hakoniwa PDU Bridge Visualizer"),
            React.createElement("div", { className: "small", style: { marginTop: ".25rem" } },
              "bridge.json editor + graph view (ReactFlow UMD) + optional Ajv validation"
            )
          ),

          React.createElement("div", { className: "main" },

            // Sidebar
            React.createElement("div", { className: "sidebar" },
              React.createElement("div", { className: "row", style: { justifyContent: "space-between" } },
                React.createElement("div", { style: { fontWeight: 900, color: "#0f172a" } }, "bridge.json"),
                React.createElement("label", { className: "btn green", style: { display: "inline-flex", alignItems: "center", gap: ".35rem" } },
                  "üìÇ Load",
                  React.createElement("input", { type: "file", accept: ".json,application/json", onChange: onFile })
                )
              ),

              React.createElement("textarea", {
                value: jsonInput,
                spellCheck: false,
                onChange: (e) => setJsonInput(e.target.value)
              }),

              React.createElement("div", { className: "row" },
                React.createElement("button", { className: "btn primary", onClick: onClickLoad }, "Load & Visualize"),
                React.createElement("button", { className: "btn gray", onClick: onClickSample }, "Sample"),
                React.createElement("button", { className: "btn amber", onClick: onExport }, "Export")
              ),

              React.createElement("div", { className: "row", style: { marginTop: ".5rem" } },
                React.createElement("button", {
                  className: "btn dark",
                  onClick: () => setSchemaEnabled(v => !v)
                }, schemaEnabled ? "Schema: ON" : "Schema: OFF"),
                React.createElement("div", { className: "small" },
                  "Ajv: " + (getAjvCtor() ? "OK" : "missing")
                )
              ),

              React.createElement("div", { className: "hint" },
                "„É°„É¢Ôºö\n" +
                "- ReactFlow UMD „ÅØ window.ReactFlow\n" +
                "- Ajv UMD „ÅØ cdnjs „ÅÆ ajv7.min.js ‚Üí window.ajv7.default\n" +
                "- Schema „ÅØ‰ªä„ÅØ„ÄåËäØ„Å†„Åë„Äç„Å™„ÅÆ„Åß„ÄÅÂé≥ÂØÜÂåñ„ÅØÂæå„ÅßÂ¢ó„ÇÑ„Åõ„Çã"
              ),

              error ? React.createElement("div", { className: "error" },
                React.createElement("div", { style: { fontWeight: 900, marginBottom: ".35rem" } }, "Error"),
                React.createElement("pre", { style: { whiteSpace: "pre-wrap", fontFamily: "ui-monospace, Menlo, monospace", fontSize: "12px" } }, error)
              ) : null,

              okMsg ? React.createElement("div", { className: "ok" },
                React.createElement("div", { style: { fontWeight: 900, marginBottom: ".2rem" } }, "OK"),
                React.createElement("div", null, okMsg)
              ) : null,

              React.createElement("div", { style: { marginTop: ".8rem", borderTop: "1px solid #e2e8f0", paddingTop: ".6rem" } },
                React.createElement("div", { className: "mini" }, "stats"),
                React.createElement("div", { className: "small mono", style: { marginTop: ".25rem" } },
                  `nodes=${stats.n}  wireLinks=${stats.wl}  policies=${stats.p}  connections=${stats.c}`
                )
              )
            ),

            // Canvas
            React.createElement("div", { className: "canvas" },
              React.createElement(ReactFlow, {
                nodes,
                edges,
                onNodesChange,
                onEdgesChange,
                nodeTypes,
                fitView: true
              },
                React.createElement(Background, { gap: 16 }),
                React.createElement(Controls),
                React.createElement(MiniMap),
                React.createElement(Panel, { position: "top-right", style: { background: "#fff", border: "1px solid #e2e8f0", borderRadius: ".5rem", padding: ".6rem" } },
                  React.createElement("div", { className: "small" },
                    React.createElement("div", null, "‚óè local = blue-ish pill"),
                    React.createElement("div", null, "‚óè wire  = purple-ish pill"),
                    React.createElement("div", null, "‚Üí wireLinks becomes edges")
                  )
                )
              )
            )
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    });
  </script>
</body>
</html>
